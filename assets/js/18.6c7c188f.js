(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{321:function(t,s,a){"use strict";a.r(s);var e=a(5),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("一般来说我们平时训练时使用的是32位浮点数（以下简称FP32），但是FP32占用内存较高，如果你的显卡的显存不够大就无法训练了，这时候可以用到量化（Quantization），将FP32压缩到FP16或者FP8以减少内存占用。QLoRA是目前比较流行的量化微调技术，它由微软在23年提出。在阅读了其相关的资料后，接下来分析一下它的核心算法。")]),t._v(" "),s("h2",{attrs:{id:"lora"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lora"}},[t._v("#")]),t._v(" LoRA")]),t._v(" "),s("p",[t._v("在分析QLoRA之前，先介绍一下它的上一代技术LoRA（low rank adaption），它是在21年被提出，相比QLoRA，它没有用到量化，但是在微调时也能减少大量内存占用。")]),t._v(" "),s("p",[t._v("在当时微调大模型时，如果你有多个下游任务可能要存储多个微调后的模型，因为基础模型比较大，导致存储需要大量的空间,每次微调会更新全量参数，耗费大量时间。")]),t._v(" "),s("p",[t._v("LoRA提出冻结预训练参数，只训练增量参数的形式。有点类似代码工程里的组件仓库，我们的工程项目一般只会使用一套框架，如果每个项目都把框架代码一起提交会使代码仓库变大，也会影响后续框架的维护。这时候就需要把框架抽成组件单独维护。同理，我们只需要存储一份预训练模型，再额外存储每个下游任务微调后的参数即可。同时，LoRA引入低秩分解，将微调参数的矩阵分解为更小的两个矩阵，减少大量训练参数。因为作者相信并假设重要的特征信息分布在低秩子空间中，在后续的实验中也证实了这个想法。LoRA的含义就是在预训练权重旁引入低秩适配器，把预训练权重和适配器权重相加就是最后的权重。")]),t._v(" "),s("p",[s("span",{staticClass:"katex-display"},[s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("h")]),s("mo",[t._v("=")]),s("msub",[s("mi",[t._v("W")]),s("mn",[t._v("0")])],1),s("mi",[t._v("x")]),s("mo",[t._v("+")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v("Δ")]),s("mrow",[s("mi",[t._v("W")])],1),s("mi",[t._v("x")]),s("mo",[t._v("=")]),s("msub",[s("mi",[t._v("W")]),s("mn",[t._v("0")])],1),s("mi",[t._v("x")]),s("mo",[t._v("+")]),s("mi",[t._v("B")]),s("mi",[t._v("A")]),s("mi",[t._v("x")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("h=W_0x+\\Delta{W}x=W_0x+BAx\n")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.69444em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.84444em","vertical-align":"-0.15em"}}),s("span",{staticClass:"base displaystyle textstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("h")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.15em","margin-right":"0.05em","margin-left":"-0.13889em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("0")])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mord mathit"},[t._v("x")]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"mord mathrm"},[t._v("Δ")]),s("span",{staticClass:"mord displaystyle textstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")])]),s("span",{staticClass:"mord mathit"},[t._v("x")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.15em","margin-right":"0.05em","margin-left":"-0.13889em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("0")])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mord mathit"},[t._v("x")]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.05017em"}},[t._v("B")]),s("span",{staticClass:"mord mathit"},[t._v("A")]),s("span",{staticClass:"mord mathit"},[t._v("x")])])])])])]),t._v(" "),s("p",[t._v("上式中h和x是线性层，"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("msub",[s("mi",[t._v("W")]),s("mn",[t._v("0")])],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("W_0")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.83333em","vertical-align":"-0.15em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.15em","margin-right":"0.05em","margin-left":"-0.13889em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("0")])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])]),t._v("是预训练权重，"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",{attrs:{mathvariant:"normal"}},[t._v("Δ")]),s("mrow",[s("mi",[t._v("W")])],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\Delta{W}")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("Δ")]),s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")])])])])]),t._v("是增量权重，低秩分解为"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("B")]),s("mi",[t._v("A")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("BA")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.05017em"}},[t._v("B")]),s("span",{staticClass:"mord mathit"},[t._v("A")])])])]),t._v("。"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("B")]),s("mo",[t._v("∈")]),s("mrow",[s("msup",[s("mi",[t._v("R")]),s("mrow",[s("mi",[t._v("d")]),s("mo",[t._v("×")]),s("mrow",[s("mi",[t._v("r")])],1)],1)],1)],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("B\\in{R^{d\\times{r}}}")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.849108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.888208em","vertical-align":"-0.0391em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.05017em"}},[t._v("B")]),s("span",{staticClass:"mrel"},[t._v("∈")]),s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.00773em"}},[t._v("R")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.363em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("d")]),s("span",{staticClass:"mbin"},[t._v("×")]),s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")])])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])])]),t._v("，"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("A")]),s("mo",[t._v("∈")]),s("mrow",[s("msup",[s("mi",[t._v("R")]),s("mrow",[s("mi",[t._v("r")]),s("mo",[t._v("×")]),s("mrow",[s("mi",[t._v("k")])],1)],1)],1)],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("A\\in{R^{r\\times{k}}}")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.849108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.888208em","vertical-align":"-0.0391em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("A")]),s("span",{staticClass:"mrel"},[t._v("∈")]),s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.00773em"}},[t._v("R")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.363em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),s("span",{staticClass:"mbin"},[t._v("×")]),s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])])]),t._v("，秩"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("r")]),s("mo",[t._v("≪")]),s("mrow",[s("mi",[t._v("m")]),s("mi",[t._v("i")]),s("mi",[t._v("n")]),s("mo",[t._v("(")]),s("mi",[t._v("d")]),s("mo",{attrs:{separator:"true"}},[t._v(",")]),s("mi",[t._v("k")]),s("mo",[t._v(")")])],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("r\\ll{min(d,k)}")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.75em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),s("span",{staticClass:"mrel"},[t._v("≪")]),s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("m")]),s("span",{staticClass:"mord mathit"},[t._v("i")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord mathit"},[t._v("d")]),s("span",{staticClass:"mpunct"},[t._v(",")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")]),s("span",{staticClass:"mclose"},[t._v(")")])])])])]),t._v("。假设d=1000，k=1000，r=8，可训练参数减少了近99%。")]),t._v(" "),s("h2",{attrs:{id:"qlora"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#qlora"}},[t._v("#")]),t._v(" QLoRA")]),t._v(" "),s("p",[t._v("QLoRA提出了3项量化技巧，分别是NF4、二次量化、分页优化。")]),t._v(" "),s("h3",{attrs:{id:"_4-bit-normalfloat-quantization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-bit-normalfloat-quantization"}},[t._v("#")]),t._v(" 4-bit NormalFloat Quantization")]),t._v(" "),s("p",[t._v("在介绍NF4之前先介绍一下量化，量化是指将模型的权重从浮点数转换为整数的过程。比如从32位浮点数转换为8位整数，这样可以减少75%的存储空间，还可以加速推理。副作用则是造成精度损失进而可能导致模型推理性能下降。")]),t._v(" "),s("p",[t._v("以下是从32位浮点数转换为8位整数的量化和反量化公式，8位整数范围[-128,127]：")]),t._v(" "),s("p",[s("span",{staticClass:"katex-display"},[s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("I")]),s("mi",[t._v("n")]),s("mi",[t._v("t")]),s("mn",[t._v("8")])],1)],1),s("mo",[t._v("=")]),s("mi",[t._v("r")]),s("mi",[t._v("o")]),s("mi",[t._v("u")]),s("mi",[t._v("n")]),s("mi",[t._v("d")]),s("mo",[t._v("(")]),s("mfrac",[s("mrow",[s("mn",[t._v("1")]),s("mn",[t._v("2")]),s("mn",[t._v("7")])],1),s("mrow",[s("mi",[t._v("a")]),s("mi",[t._v("b")]),s("mi",[t._v("s")]),s("mi",[t._v("m")]),s("mi",[t._v("a")]),s("mi",[t._v("x")]),s("mo",[t._v("(")]),s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1),s("mo",[t._v(")")])],1)],1),s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1),s("mo",[t._v(")")]),s("mo",[t._v("=")]),s("mi",[t._v("r")]),s("mi",[t._v("o")]),s("mi",[t._v("u")]),s("mi",[t._v("n")]),s("mi",[t._v("d")]),s("mo",[t._v("(")]),s("msup",[s("mi",[t._v("c")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1),s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1),s("mo",[t._v(")")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X^{Int8}=round(\\frac{127}{absmax(X^{FP32})}X^{FP32})=round(c^{FP32}X^{FP32})\n")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"1.32144em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"2.25744em","vertical-align":"-0.936em"}}),s("span",{staticClass:"base displaystyle textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("I")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("t")]),s("span",{staticClass:"mord mathrm"},[t._v("8")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),s("span",{staticClass:"mord mathit"},[t._v("o")]),s("span",{staticClass:"mord mathit"},[t._v("u")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("d")]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord reset-textstyle displaystyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.686em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle cramped"},[s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord mathit"},[t._v("a")]),s("span",{staticClass:"mord mathit"},[t._v("b")]),s("span",{staticClass:"mord mathit"},[t._v("s")]),s("span",{staticClass:"mord mathit"},[t._v("m")]),s("span",{staticClass:"mord mathit"},[t._v("a")]),s("span",{staticClass:"mord mathit"},[t._v("x")]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.289em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mclose"},[t._v(")")])])])]),s("span",{staticStyle:{top:"-0.2300000000000001em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.677em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped"},[s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("7")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mclose"},[t._v(")")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),s("span",{staticClass:"mord mathit"},[t._v("o")]),s("span",{staticClass:"mord mathit"},[t._v("u")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("d")]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit"},[t._v("c")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),s("p",[t._v("上式中的c指的是量化常数或者量化比例。")]),t._v(" "),s("p",[s("span",{staticClass:"katex-display"},[s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("d")]),s("mi",[t._v("e")]),s("mi",[t._v("q")]),s("mi",[t._v("u")]),s("mi",[t._v("a")]),s("mi",[t._v("n")]),s("mi",[t._v("t")]),s("mo",[t._v("(")]),s("msup",[s("mi",[t._v("c")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1),s("mo",{attrs:{separator:"true"}},[t._v(",")]),s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("I")]),s("mi",[t._v("n")]),s("mi",[t._v("t")]),s("mn",[t._v("8")])],1)],1),s("mo",[t._v(")")]),s("mo",[t._v("=")]),s("mfrac",[s("mrow",[s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("I")]),s("mi",[t._v("n")]),s("mi",[t._v("t")]),s("mn",[t._v("8")])],1)],1)],1),s("mrow",[s("msup",[s("mi",[t._v("c")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1)],1)],1),s("mo",[t._v("=")]),s("msup",[s("mi",[t._v("X")]),s("mrow",[s("mi",[t._v("F")]),s("mi",[t._v("P")]),s("mn",[t._v("3")]),s("mn",[t._v("2")])],1)],1)],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("dequant(c^{FP32},X^{Int8})=\\frac{X^{Int8}}{c^{FP32}}=X^{FP32}\n")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"1.5183309999999999em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"2.204331em","vertical-align":"-0.686em"}}),s("span",{staticClass:"base displaystyle textstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("d")]),s("span",{staticClass:"mord mathit"},[t._v("e")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03588em"}},[t._v("q")]),s("span",{staticClass:"mord mathit"},[t._v("u")]),s("span",{staticClass:"mord mathit"},[t._v("a")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("t")]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit"},[t._v("c")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mpunct"},[t._v(",")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("I")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("t")]),s("span",{staticClass:"mord mathrm"},[t._v("8")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mclose"},[t._v(")")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord reset-textstyle displaystyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.686em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle cramped"},[s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit"},[t._v("c")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.289em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.677em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped"},[s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.363em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("I")]),s("span",{staticClass:"mord mathit"},[t._v("n")]),s("span",{staticClass:"mord mathit"},[t._v("t")]),s("span",{staticClass:"mord mathrm"},[t._v("8")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.413em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("F")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.13889em"}},[t._v("P")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])])])])])])]),t._v(" "),s("p",[t._v("这个方法的缺陷是如果输入向量里出现一个特别大的值，会导致数据量化后分布不均匀，进而导致更多的精度损失。解决这个问题的办法是将输入向量分块，每块独立量化，都有各自的量化常数，这样可以把异常值控制在一部分区间里。")]),t._v(" "),s("p",[t._v("NormalFloat4量化就是基于分块量化并使用NormalFloat4数据类型。那么它是如何充分利用16个位数呢？由于预训练神经网络权重通常符合零中心的正态分布，于是我们可以在正态分布上划分16个区间，每个区间的面积相等，设置范围[-1,1]，将分位数和权重都做归一化。这里的分位数指的是每个区间的中点。")]),t._v(" "),s("p",[t._v("那么具体的16个分位数是如何计算的呢？如果按等比例划分16个区间，会导致没有零值，然而零值在权重里表示了特殊的含义，如果没有的话会导致原来为零的权重经过量化和反量化后无法回到零值，这就造成了很大的误差。所以论文里采用了非对称的划分方式，以0坐标为中心，左边取"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("msup",[s("mn",[t._v("2")]),s("mi",[t._v("k")])],1),s("mo",[t._v("=")]),s("mn",[t._v("8")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2^k=8")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.849108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.849108em","vertical-align":"0em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.363em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("8")])])])]),t._v("个分位数，右边取"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("msup",[s("mn",[t._v("2")]),s("mi",[t._v("k")])],1),s("mo",[t._v("+")]),s("mn",[t._v("1")]),s("mo",[t._v("=")]),s("mn",[t._v("9")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2^k+1=9")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.849108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"0.932438em","vertical-align":"-0.08333em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"-0.363em","margin-right":"0.05em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("9")])])])]),t._v("个分位数，左右合并后去掉重复的0点共16个分位数。但是这里有一个问题，因为-1和1是取不到的，如果使用norm.ppf计算分位数分别得到的是正无穷和nan，所以需要对范围做一下偏移。")]),t._v(" "),s("p",[t._v("论文中使用的是0.9677083，它的解释是左右两边的区间按中点（分位数）划分分别是15和16个半区间，各取半个求平均值，所以偏移量公式：")]),t._v(" "),s("p",[s("span",{staticClass:"katex-display"},[s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mi",[t._v("o")]),s("mi",[t._v("f")]),s("mi",[t._v("f")]),s("mi",[t._v("s")]),s("mi",[t._v("e")]),s("mi",[t._v("t")]),s("mo",[t._v("=")]),s("mfrac",[s("mrow",[s("mn",[t._v("1")])],1),s("mrow",[s("mn",[t._v("2")])],1)],1),s("mo",[t._v("(")]),s("mfrac",[s("mrow",[s("mn",[t._v("1")])],1),s("mrow",[s("mn",[t._v("2")]),s("mo",[t._v("∗")]),s("mn",[t._v("1")]),s("mn",[t._v("5")])],1)],1),s("mo",[t._v("+")]),s("mfrac",[s("mrow",[s("mn",[t._v("1")])],1),s("mrow",[s("mn",[t._v("2")]),s("mo",[t._v("∗")]),s("mn",[t._v("1")]),s("mn",[t._v("6")])],1)],1),s("mo",[t._v(")")]),s("mo",[t._v("=")]),s("mn",[t._v("1")]),s("mo",[t._v("−")]),s("mn",[t._v("0")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v(".")]),s("mn",[t._v("9")]),s("mn",[t._v("6")]),s("mn",[t._v("7")]),s("mn",[t._v("7")]),s("mn",[t._v("0")]),s("mn",[t._v("8")]),s("mn",[t._v("3")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("offset=\\frac{1}{2}(\\frac{1}{2*15}+\\frac{1}{2*16})=1-0.9677083\n")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"1.32144em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"2.00744em","vertical-align":"-0.686em"}}),s("span",{staticClass:"base displaystyle textstyle uncramped"},[s("span",{staticClass:"mord mathit"},[t._v("o")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.10764em"}},[t._v("f")]),s("span",{staticClass:"mord mathit",staticStyle:{"margin-right":"0.10764em"}},[t._v("f")]),s("span",{staticClass:"mord mathit"},[t._v("s")]),s("span",{staticClass:"mord mathit"},[t._v("e")]),s("span",{staticClass:"mord mathit"},[t._v("t")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord reset-textstyle displaystyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.686em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle cramped"},[s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.677em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped"},[s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("1")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mopen"},[t._v("(")]),s("span",{staticClass:"mord reset-textstyle displaystyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.686em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle cramped"},[s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mbin"},[t._v("∗")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("5")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.677em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped"},[s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("1")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"mord reset-textstyle displaystyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.686em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle cramped"},[s("span",{staticClass:"mord textstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mbin"},[t._v("∗")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("6")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.677em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped"},[s("span",{staticClass:"mord textstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("1")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mclose"},[t._v(")")]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mbin"},[t._v("−")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v(".")]),s("span",{staticClass:"mord mathrm"},[t._v("9")]),s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("7")]),s("span",{staticClass:"mord mathrm"},[t._v("7")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v("8")]),s("span",{staticClass:"mord mathrm"},[t._v("3")])])])])])]),t._v(" "),s("p",[t._v("以下是NF4的量化和反量化过程：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/images/qlora_quantize_dequantize.png",alt:"NF4的量化和反量化过程"}})]),t._v(" "),s("p",[t._v("图中反量化后的值和量化前的值有误差，这就是量化后的精度损失。")]),t._v(" "),s("h3",{attrs:{id:"double-quantization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#double-quantization"}},[t._v("#")]),t._v(" Double Quantization")]),t._v(" "),s("p",[t._v("在分块量化的基础上使用二次量化，例如每个块含有64个参数，每个块需要一个量化常数(32位)，那么在未使用二次量化之前每个参数额外需要"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mfrac",[s("mrow",[s("mn",[t._v("3")]),s("mn",[t._v("2")])],1),s("mrow",[s("mn",[t._v("6")]),s("mn",[t._v("4")])],1)],1),s("mo",[t._v("=")]),s("mn",[t._v("0")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v(".")]),s("mn",[t._v("5")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\frac{32}{64}=0.5")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.845108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"1.190108em","vertical-align":"-0.345em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord reset-textstyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.345em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("4")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.394em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v(".")]),s("span",{staticClass:"mord mathrm"},[t._v("5")])])])]),t._v("位。二次量化针对的就是额外增加的量化常数，量化到8位，论文中使用256个量化常数组成一个块，那么每个参数额外需要"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mfrac",[s("mrow",[s("mn",[t._v("3")]),s("mn",[t._v("2")])],1),s("mrow",[s("mn",[t._v("6")]),s("mn",[t._v("4")]),s("mo",[t._v("∗")]),s("mn",[t._v("2")]),s("mn",[t._v("5")]),s("mn",[t._v("6")])],1)],1),s("mo",[t._v("=")]),s("mn",[t._v("0")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v(".")]),s("mn",[t._v("0")]),s("mn",[t._v("0")]),s("mn",[t._v("1")]),s("mn",[t._v("9")]),s("mn",[t._v("5")]),s("mn",[t._v("3")]),s("mn",[t._v("1")]),s("mn",[t._v("2")]),s("mn",[t._v("5")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\frac{32}{64*256}=0.001953125")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.845108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"1.190108em","vertical-align":"-0.345em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord reset-textstyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.345em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("4")]),s("span",{staticClass:"mbin"},[t._v("∗")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("5")]),s("span",{staticClass:"mord mathrm"},[t._v("6")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.394em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v(".")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("9")]),s("span",{staticClass:"mord mathrm"},[t._v("5")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("5")])])])]),t._v("位，加起来额外总共需要"),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",[s("semantics",[s("mrow",[s("mfrac",[s("mrow",[s("mn",[t._v("8")])],1),s("mrow",[s("mn",[t._v("6")]),s("mn",[t._v("4")])],1)],1),s("mo",[t._v("+")]),s("mfrac",[s("mrow",[s("mn",[t._v("3")]),s("mn",[t._v("2")])],1),s("mrow",[s("mn",[t._v("6")]),s("mn",[t._v("4")]),s("mo",[t._v("∗")]),s("mn",[t._v("2")]),s("mn",[t._v("5")]),s("mn",[t._v("6")])],1)],1),s("mo",[t._v("=")]),s("mn",[t._v("0")]),s("mi",{attrs:{mathvariant:"normal"}},[t._v(".")]),s("mn",[t._v("1")]),s("mn",[t._v("2")]),s("mn",[t._v("6")]),s("mn",[t._v("9")]),s("mn",[t._v("5")]),s("mn",[t._v("3")]),s("mn",[t._v("1")]),s("mn",[t._v("2")]),s("mn",[t._v("5")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\frac{8}{64}+\\frac{32}{64*256}=0.126953125")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"strut",staticStyle:{height:"0.845108em"}}),s("span",{staticClass:"strut bottom",staticStyle:{height:"1.190108em","vertical-align":"-0.345em"}}),s("span",{staticClass:"base textstyle uncramped"},[s("span",{staticClass:"mord reset-textstyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.345em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("4")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.394em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("8")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mbin"},[t._v("+")]),s("span",{staticClass:"mord reset-textstyle textstyle uncramped"},[s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"}),s("span",{staticClass:"mfrac"},[s("span",{staticClass:"vlist"},[s("span",{staticStyle:{top:"0.345em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle cramped"},[s("span",{staticClass:"mord scriptstyle cramped"},[s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("4")]),s("span",{staticClass:"mbin"},[t._v("∗")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("5")]),s("span",{staticClass:"mord mathrm"},[t._v("6")])])])]),s("span",{staticStyle:{top:"-0.22999999999999998em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle textstyle uncramped frac-line"})]),s("span",{staticStyle:{top:"-0.394em"}},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),s("span",{staticClass:"reset-textstyle scriptstyle uncramped"},[s("span",{staticClass:"mord scriptstyle uncramped"},[s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("2")])])])]),s("span",{staticClass:"baseline-fix"},[s("span",{staticClass:"fontsize-ensurer reset-size5 size5"},[s("span",{staticStyle:{"font-size":"0em"}},[t._v("​")])]),t._v("​")])])]),s("span",{staticClass:"sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"})]),s("span",{staticClass:"mrel"},[t._v("=")]),s("span",{staticClass:"mord mathrm"},[t._v("0")]),s("span",{staticClass:"mord mathrm"},[t._v(".")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("6")]),s("span",{staticClass:"mord mathrm"},[t._v("9")]),s("span",{staticClass:"mord mathrm"},[t._v("5")]),s("span",{staticClass:"mord mathrm"},[t._v("3")]),s("span",{staticClass:"mord mathrm"},[t._v("1")]),s("span",{staticClass:"mord mathrm"},[t._v("2")]),s("span",{staticClass:"mord mathrm"},[t._v("5")])])])]),t._v("位。二次量化节省了约75%的空间。")]),t._v(" "),s("h3",{attrs:{id:"paged-optimizers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#paged-optimizers"}},[t._v("#")]),t._v(" Paged Optimizers")]),t._v(" "),s("p",[t._v("内存分页优化，利用了CUDA的统一内存特性，前提是需要显卡和CUDA版本支持。该特性在CPU和GPU之间进行自动页面传输，以确保在GPU偶尔内存不足的情况下进行无误的GPU处理。该特性类似于CPU RAM和磁盘之间的常规内存分页。我们利用此特性为优化器状态分配分页内存，当GPU内存不足时，这些状态会自动转移到CPU RAM 中，并在优化器更新步骤需要内存时分页回到GPU内存中。")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L227",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L227"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("to_gpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" gindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" group "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enumerate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("param_groups"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" pindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enumerate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"params"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                values "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" k"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" values"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("isinstance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Tensor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                        is_paged "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("getattr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"is_paged"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" is_paged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                            self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("to"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("device"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("如果开启分页优化，tensor将不会被显示传输到指定设备，交由CUDA自动管理。")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L286",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L286"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" gindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" group "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enumerate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("param_groups"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" pindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enumerate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"params"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("grad "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n        state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("init_state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prefetch_state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_step"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pindex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        torch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cuda"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("synchronize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("a",{attrs:{href:"https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L329",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L329"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("prefetch_state")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_paged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        s1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"state1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        is_paged "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("getattr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"is_paged"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" is_paged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            F"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prefetch_tensor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"state1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"state2"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                F"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prefetch_tensor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"state2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("在执行优化器步骤之前对内存预调用。")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/functional.py#L194",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/functional.py#L194"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("prefetch_tensor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" to_cpu"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_paged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Only paged tensors can be prefetched!"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" to_cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        deviceid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        deviceid "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("page_deviceid\n\n    num_bytes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dtype2bytes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dtype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("numel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    lib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cprefetch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("get_ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("c_size_t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("num_bytes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("c_int32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deviceid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("a",{attrs:{href:"https://github.com/TimDettmers/bitsandbytes/blob/main/csrc/pythonInterface.cpp#L389",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/TimDettmers/bitsandbytes/blob/main/csrc/pythonInterface.cpp#L389"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-c++ extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("void cprefetch(void *ptr, size_t bytes, int device)\n{\n  int hasPrefetch = 0;\n  CUDA_CHECK_RETURN(cudaDeviceGetAttribute(&hasPrefetch, cudaDevAttrConcurrentManagedAccess, device)); // 40ns overhead\n  if (hasPrefetch == 0) return;\n\n  CUDA_CHECK_RETURN(cudaMemPrefetchAsync(ptr, bytes, device, 0));\n  CUDA_CHECK_RETURN(cudaPeekAtLastError());\n}\n")])])]),s("p",[t._v("实际调用的是CUDA的接口，"),s("code",[t._v("cudaMemPrefetchAsync")]),t._v(" 是 CUDA 提供的一个异步内存预取函数，用于在程序中显式地预取内存数据到 GPU 上，以加速后续对数据的访问。")]),t._v(" "),s("p",[t._v("整个流程是我们把内存交给CUDA管理，在优化器需要内存时，我们提示CUDA需要在GPU上用到多少内存，提前传输过去，加速后续访问。如果GPU内存吃紧，CUDA会自动把部分数据传输回CPU内存。")]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://arxiv.org/pdf/2106.09685.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("LORA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://arxiv.org/pdf/2305.14314v1.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("QLoRA: Efficient Finetuning of Quantized LLMs"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://fancyerii.github.io/2023/12/14/qlora/",target:"_blank",rel:"noopener noreferrer"}},[t._v("QLoRA: Efficient Finetuning of Quantized LLMs论文解读"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://readpaper.feishu.cn/docx/CrMGdSVPKow5d1x1XQMcJioRnQe",target:"_blank",rel:"noopener noreferrer"}},[t._v("QLoRA: 训练更大的GPT"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://huggingface.co/blog/zh/4bit-transformers-bitsandbytes",target:"_blank",rel:"noopener noreferrer"}},[t._v("用 bitsandbytes、4 比特量化和 QLoRA 打造亲民的 LLM"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);