<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>QLORA：量化LLM的高效微调 | 风之谷</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="

一般来说我们平时训练时使用的是32位浮点数（以下简称FP32），但是FP32占用内存较高，如果你的显卡的显存不够大就无法训练了，这时候可以用到量化（Quantization），将FP32压缩到FP16或者FP8以减少内存占用。QLoRA是目前比较流行的量化微调技术，它由微软在23年提出。在阅读了其相关的资料后，接下来分析一下它的核心算法。

LoRA

在分析QLoRA之前，先介绍一下它 ...">
    
    <link rel="preload" href="/assets/css/0.styles.82ff4c1c.css" as="style"><link rel="preload" href="/assets/js/app.d26a87a3.js" as="script"><link rel="preload" href="/assets/js/6.f588e3a4.js" as="script"><link rel="preload" href="/assets/js/3.46d2affe.js" as="script"><link rel="preload" href="/assets/js/18.83909f3e.js" as="script"><link rel="prefetch" href="/assets/js/10.04fcc694.js"><link rel="prefetch" href="/assets/js/11.20194e5d.js"><link rel="prefetch" href="/assets/js/12.7245c36e.js"><link rel="prefetch" href="/assets/js/13.a4676484.js"><link rel="prefetch" href="/assets/js/14.aa96bfbd.js"><link rel="prefetch" href="/assets/js/15.62aaec84.js"><link rel="prefetch" href="/assets/js/16.b747235b.js"><link rel="prefetch" href="/assets/js/17.44b879c8.js"><link rel="prefetch" href="/assets/js/19.821915b5.js"><link rel="prefetch" href="/assets/js/20.4fc1b68e.js"><link rel="prefetch" href="/assets/js/21.b25c1f18.js"><link rel="prefetch" href="/assets/js/22.9a7eb7c3.js"><link rel="prefetch" href="/assets/js/23.6c4cbefd.js"><link rel="prefetch" href="/assets/js/24.2c628b20.js"><link rel="prefetch" href="/assets/js/25.9c0d5a23.js"><link rel="prefetch" href="/assets/js/26.48c0b155.js"><link rel="prefetch" href="/assets/js/27.d6892516.js"><link rel="prefetch" href="/assets/js/28.dfcfcfbb.js"><link rel="prefetch" href="/assets/js/29.cbd059a4.js"><link rel="prefetch" href="/assets/js/30.4322f5dc.js"><link rel="prefetch" href="/assets/js/31.442fe0fd.js"><link rel="prefetch" href="/assets/js/32.255c1b5b.js"><link rel="prefetch" href="/assets/js/33.0a8afd6c.js"><link rel="prefetch" href="/assets/js/34.beafdd4a.js"><link rel="prefetch" href="/assets/js/35.0feb8a64.js"><link rel="prefetch" href="/assets/js/36.331f70bc.js"><link rel="prefetch" href="/assets/js/37.034ac323.js"><link rel="prefetch" href="/assets/js/38.9a541c14.js"><link rel="prefetch" href="/assets/js/4.33f369b0.js"><link rel="prefetch" href="/assets/js/5.db94fb56.js"><link rel="prefetch" href="/assets/js/7.2b7ee228.js"><link rel="prefetch" href="/assets/js/8.da88cc7c.js"><link rel="prefetch" href="/assets/js/9.3cb34b32.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.ac365ac7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.82ff4c1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">风之谷 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/ai/" class="nav-link router-link-active">AI</a></li><li class="nav-item"><a href="/leetcode/" class="nav-link">LeetCode</a></li><li class="nav-item"><a href="/devtools/" class="nav-link">DevTools</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">风之谷 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/ai/" class="nav-link router-link-active">AI</a></li><li class="mobile-nav-item"><a href="/leetcode/" class="nav-link">LeetCode</a></li><li class="mobile-nav-item"><a href="/devtools/" class="nav-link">DevTools</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        QLORA：量化LLM的高效微调
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2024-04-11T00:00:00.000Z">
      Thu Apr 11 2024
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/ai" data-v-42ccfcd5><span data-v-42ccfcd5>ai</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/qlora" data-v-42ccfcd5><span data-v-42ccfcd5>qlora</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/quantization" data-v-42ccfcd5><span data-v-42ccfcd5>quantization</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>一般来说我们平时训练时使用的是32位浮点数（以下简称FP32），但是FP32占用内存较高，如果你的显卡的显存不够大就无法训练了，这时候可以用到量化（Quantization），将FP32压缩到FP16或者FP8以减少内存占用。QLoRA是目前比较流行的量化微调技术，它由微软在23年提出。在阅读了其相关的资料后，接下来分析一下它的核心算法。</p> <h2 id="lora"><a href="#lora" class="header-anchor">#</a> LoRA</h2> <p>在分析QLoRA之前，先介绍一下它的上一代技术LoRA（low rank adaption），它是在21年被提出，相比QLoRA，它没有用到量化，但是在微调时也能减少大量内存占用。</p> <p>在当时微调大模型时，如果你有多个下游任务可能要存储多个微调后的模型，因为基础模型比较大，导致存储需要大量的空间,每次微调会更新全量参数，耗费大量时间。</p> <p>LoRA提出冻结预训练参数，只训练增量参数的形式。有点类似代码工程里的组件仓库，我们的工程项目一般只会使用一套框架，如果每个项目都把框架代码一起提交会使代码仓库变大，也会影响后续框架的维护。这时候就需要把框架抽成组件单独维护。同理，我们只需要存储一份预训练模型，再额外存储每个下游任务微调后的参数即可。同时，LoRA引入低秩分解，将微调参数的矩阵分解为更小的两个矩阵，减少大量训练参数。因为作者相信并假设重要的特征信息分布在低秩子空间中，在后续的实验中也证实了这个想法。LoRA的含义就是在预训练权重旁引入低秩适配器，把预训练权重和适配器权重相加就是最后的权重。</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>h</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mi>x</mi><mo>+</mo><mi mathvariant="normal">Δ</mi><mrow><mi>W</mi></mrow><mi>x</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mi>x</mi><mo>+</mo><mi>B</mi><mi>A</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">h=W_0x+\Delta{W}x=W_0x+BAx
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">h</span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">x</span><span class="mbin">+</span><span class="mord mathrm">Δ</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">W</span></span><span class="mord mathit">x</span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">x</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">A</span><span class="mord mathit">x</span></span></span></span></span></p> <p>上式中h和x是线性层，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>是预训练权重，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">Δ</mi><mrow><mi>W</mi></mrow></mrow><annotation encoding="application/x-tex">\Delta{W}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">Δ</span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">W</span></span></span></span></span>是增量权重，低秩分解为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">BA</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">A</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi><mo>∈</mo><mrow><msup><mi>R</mi><mrow><mi>d</mi><mo>×</mo><mrow><mi>r</mi></mrow></mrow></msup></mrow></mrow><annotation encoding="application/x-tex">B\in{R^{d\times{r}}}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.849108em;"></span><span class="strut bottom" style="height:0.888208em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mrel">∈</span><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mbin">×</span><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>∈</mo><mrow><msup><mi>R</mi><mrow><mi>r</mi><mo>×</mo><mrow><mi>k</mi></mrow></mrow></msup></mrow></mrow><annotation encoding="application/x-tex">A\in{R^{r\times{k}}}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.849108em;"></span><span class="strut bottom" style="height:0.888208em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">A</span><span class="mrel">∈</span><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mbin">×</span><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span>，秩<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mo>≪</mo><mrow><mi>m</mi><mi>i</mi><mi>n</mi><mo>(</mo><mi>d</mi><mo separator="true">,</mo><mi>k</mi><mo>)</mo></mrow></mrow><annotation encoding="application/x-tex">r\ll{min(d,k)}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mrel">≪</span><span class="mord textstyle uncramped"><span class="mord mathit">m</span><span class="mord mathit">i</span><span class="mord mathit">n</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></span>。假设d=1000，k=1000，r=8，可训练参数减少了近99%。</p> <h2 id="qlora"><a href="#qlora" class="header-anchor">#</a> QLoRA</h2> <p>QLoRA提出了3项量化技巧，分别是NF4、二次量化、分页优化。</p> <h3 id="_4-bit-normalfloat-quantization"><a href="#_4-bit-normalfloat-quantization" class="header-anchor">#</a> 4-bit NormalFloat Quantization</h3> <p>在介绍NF4之前先介绍一下量化，量化是指将模型的权重从浮点数转换为整数的过程。比如从32位浮点数转换为8位整数，这样可以减少75%的存储空间，还可以加速推理。副作用则是造成精度损失进而可能导致模型推理性能下降。</p> <p>以下是从32位浮点数转换为8位整数的量化和反量化公式，8位整数范围[-128,127]：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>X</mi><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mn>8</mn></mrow></msup><mo>=</mo><mi>r</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>d</mi><mo>(</mo><mfrac><mrow><mn>1</mn><mn>2</mn><mn>7</mn></mrow><mrow><mi>a</mi><mi>b</mi><mi>s</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo>(</mo><msup><mi>X</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup><mo>)</mo></mrow></mfrac><msup><mi>X</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup><mo>)</mo><mo>=</mo><mi>r</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>d</mi><mo>(</mo><msup><mi>c</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup><msup><mi>X</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">X^{Int8}=round(\frac{127}{absmax(X^{FP32})}X^{FP32})=round(c^{FP32}X^{FP32})
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.25744em;vertical-align:-0.936em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.07847em;">I</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathrm">8</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mopen">(</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">s</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.289em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span><span style="top:-0.2300000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">7</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mord mathit">n</span><span class="mord mathit">d</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">c</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span></span></p> <p>上式中的c指的是量化常数或者量化比例。</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>a</mi><mi>n</mi><mi>t</mi><mo>(</mo><msup><mi>c</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup><mo separator="true">,</mo><msup><mi>X</mi><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mn>8</mn></mrow></msup><mo>)</mo><mo>=</mo><mfrac><mrow><msup><mi>X</mi><mrow><mi>I</mi><mi>n</mi><mi>t</mi><mn>8</mn></mrow></msup></mrow><mrow><msup><mi>c</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup></mrow></mfrac><mo>=</mo><msup><mi>X</mi><mrow><mi>F</mi><mi>P</mi><mn>3</mn><mn>2</mn></mrow></msup></mrow><annotation encoding="application/x-tex">dequant(c^{FP32},X^{Int8})=\frac{X^{Int8}}{c^{FP32}}=X^{FP32}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.5183309999999999em;"></span><span class="strut bottom" style="height:2.204331em;vertical-align:-0.686em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="mord mathit">u</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">c</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.07847em;">I</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathrm">8</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">c</span><span class="vlist"><span style="top:-0.289em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.07847em;">I</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathrm">8</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.07847em;">X</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">F</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p> <p>这个方法的缺陷是如果输入向量里出现一个特别大的值，会导致数据量化后分布不均匀，进而导致更多的精度损失。解决这个问题的办法是将输入向量分块，每块独立量化，都有各自的量化常数，这样可以把异常值控制在一部分区间里。</p> <p>NormalFloat4量化就是基于分块量化并使用NormalFloat4数据类型。那么它是如何充分利用16个位数呢？由于预训练神经网络权重通常符合零中心的正态分布，于是我们可以在正态分布上划分16个区间，每个区间的面积相等，设置范围[-1,1]，将分位数和权重都做归一化。这里的分位数指的是每个区间的中点。</p> <p>那么具体的16个分位数是如何计算的呢？如果按等比例划分16个区间，会导致没有零值，然而零值在权重里表示了特殊的含义，如果没有的话会导致原来为零的权重经过量化和反量化后无法回到零值，这就造成了很大的误差。所以论文里采用了非对称的划分方式，以0坐标为中心，左边取<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup><mo>=</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">2^k=8</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.849108em;"></span><span class="strut bottom" style="height:0.849108em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathrm">2</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">8</span></span></span></span>个分位数，右边取<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup><mo>+</mo><mn>1</mn><mo>=</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">2^k+1=9</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.849108em;"></span><span class="strut bottom" style="height:0.932438em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathrm">2</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mrel">=</span><span class="mord mathrm">9</span></span></span></span>个分位数，左右合并后去掉重复的0点共16个分位数。但是这里有一个问题，因为-1和1是取不到的，如果使用norm.ppf计算分位数分别得到的是正无穷和nan，所以需要对范围做一下偏移。</p> <p>论文中使用的是0.9677083，它的解释是左右两边的区间按中点（分位数）划分分别是15和16个半区间，各取半个求平均值，所以偏移量公式：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>o</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>2</mn></mrow></mfrac><mo>(</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>2</mn><mo>∗</mo><mn>1</mn><mn>5</mn></mrow></mfrac><mo>+</mo><mfrac><mrow><mn>1</mn></mrow><mrow><mn>2</mn><mo>∗</mo><mn>1</mn><mn>6</mn></mrow></mfrac><mo>)</mo><mo>=</mo><mn>1</mn><mo>−</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>9</mn><mn>6</mn><mn>7</mn><mn>7</mn><mn>0</mn><mn>8</mn><mn>3</mn></mrow><annotation encoding="application/x-tex">offset=\frac{1}{2}(\frac{1}{2*15}+\frac{1}{2*16})=1-0.9677083
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.32144em;"></span><span class="strut bottom" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">s</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">2</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mopen">(</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">2</span><span class="mbin">∗</span><span class="mord mathrm">1</span><span class="mord mathrm">5</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">+</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">2</span><span class="mbin">∗</span><span class="mord mathrm">1</span><span class="mord mathrm">6</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">−</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">9</span><span class="mord mathrm">6</span><span class="mord mathrm">7</span><span class="mord mathrm">7</span><span class="mord mathrm">0</span><span class="mord mathrm">8</span><span class="mord mathrm">3</span></span></span></span></span></p> <p>以下是NF4的量化和反量化过程：</p> <p><img src="/images/qlora_quantize_dequantize.png" alt="NF4的量化和反量化过程"></p> <p>图中反量化后的值和量化前的值有误差，这就是量化后的精度损失。</p> <h3 id="double-quantization"><a href="#double-quantization" class="header-anchor">#</a> Double Quantization</h3> <p>在分块量化的基础上使用二次量化，例如每个块含有64个参数，每个块需要一个量化常数(32位)，那么在未使用二次量化之前每个参数额外需要<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>3</mn><mn>2</mn></mrow><mrow><mn>6</mn><mn>4</mn></mrow></mfrac><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn></mrow><annotation encoding="application/x-tex">\frac{32}{64}=0.5</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">6</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span></span></span></span>位。二次量化针对的就是额外增加的量化常数，量化到8位，论文中使用256个量化常数组成一个块，那么每个参数额外需要<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>3</mn><mn>2</mn></mrow><mrow><mn>6</mn><mn>4</mn><mo>∗</mo><mn>2</mn><mn>5</mn><mn>6</mn></mrow></mfrac><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>0</mn><mn>0</mn><mn>1</mn><mn>9</mn><mn>5</mn><mn>3</mn><mn>1</mn><mn>2</mn><mn>5</mn></mrow><annotation encoding="application/x-tex">\frac{32}{64*256}=0.001953125</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">6</span><span class="mord mathrm">4</span><span class="mbin">∗</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathrm">6</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mord mathrm">5</span><span class="mord mathrm">3</span><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span></span></span></span>位，加起来额外总共需要<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>8</mn></mrow><mrow><mn>6</mn><mn>4</mn></mrow></mfrac><mo>+</mo><mfrac><mrow><mn>3</mn><mn>2</mn></mrow><mrow><mn>6</mn><mn>4</mn><mo>∗</mo><mn>2</mn><mn>5</mn><mn>6</mn></mrow></mfrac><mo>=</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>1</mn><mn>2</mn><mn>6</mn><mn>9</mn><mn>5</mn><mn>3</mn><mn>1</mn><mn>2</mn><mn>5</mn></mrow><annotation encoding="application/x-tex">\frac{8}{64}+\frac{32}{64*256}=0.126953125</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.845108em;"></span><span class="strut bottom" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">6</span><span class="mord mathrm">4</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">8</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">+</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">6</span><span class="mord mathrm">4</span><span class="mbin">∗</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathrm">6</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mrel">=</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">6</span><span class="mord mathrm">9</span><span class="mord mathrm">5</span><span class="mord mathrm">3</span><span class="mord mathrm">1</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span></span></span></span>位。二次量化节省了约75%的空间。</p> <h3 id="paged-optimizers"><a href="#paged-optimizers" class="header-anchor">#</a> Paged Optimizers</h3> <p>内存分页优化，利用了CUDA的统一内存特性，前提是需要显卡和CUDA版本支持。该特性在CPU和GPU之间进行自动页面传输，以确保在GPU偶尔内存不足的情况下进行无误的GPU处理。该特性类似于CPU RAM和磁盘之间的常规内存分页。我们利用此特性为优化器状态分配分页内存，当GPU内存不足时，这些状态会自动转移到CPU RAM 中，并在优化器更新步骤需要内存时分页回到GPU内存中。</p> <p><a href="https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L227" target="_blank" rel="noopener noreferrer">https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L227<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">to_gpu</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> gindex<span class="token punctuation">,</span> group <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>param_groups<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> pindex<span class="token punctuation">,</span> p <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> p <span class="token keyword">in</span> self<span class="token punctuation">.</span>state<span class="token punctuation">:</span>
                values <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
                <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> values<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        is_paged <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token string">&quot;is_paged&quot;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token keyword">not</span> is_paged<span class="token punctuation">:</span>
                            self<span class="token punctuation">.</span>state<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>to<span class="token punctuation">(</span>p<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
</code></pre></div><p>如果开启分页优化，tensor将不会被显示传输到指定设备，交由CUDA自动管理。</p> <p><a href="https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L286" target="_blank" rel="noopener noreferrer">https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L286<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> gindex<span class="token punctuation">,</span> group <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>param_groups<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> pindex<span class="token punctuation">,</span> p <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>group<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>grad <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        state <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>init_state<span class="token punctuation">(</span>group<span class="token punctuation">,</span> p<span class="token punctuation">,</span> gindex<span class="token punctuation">,</span> pindex<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>prefetch_state<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_step<span class="token punctuation">(</span>group<span class="token punctuation">,</span> p<span class="token punctuation">,</span> gindex<span class="token punctuation">,</span> pindex<span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>synchronize<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><a href="https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L329" target="_blank" rel="noopener noreferrer">https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/optim/optimizer.py#L329<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">prefetch_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_paged<span class="token punctuation">:</span>
        state <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
        s1 <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">&quot;state1&quot;</span><span class="token punctuation">]</span>
        is_paged <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">&quot;is_paged&quot;</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> is_paged<span class="token punctuation">:</span>
            F<span class="token punctuation">.</span>prefetch_tensor<span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token string">&quot;state1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">&quot;state2&quot;</span> <span class="token keyword">in</span> state<span class="token punctuation">:</span>
                F<span class="token punctuation">.</span>prefetch_tensor<span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token string">&quot;state2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>在执行优化器步骤之前对内存预调用。</p> <p><a href="https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/functional.py#L194" target="_blank" rel="noopener noreferrer">https://github.com/TimDettmers/bitsandbytes/blob/main/bitsandbytes/functional.py#L194<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">prefetch_tensor</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> to_cpu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> A<span class="token punctuation">.</span>is_paged<span class="token punctuation">,</span> <span class="token string">&quot;Only paged tensors can be prefetched!&quot;</span>
    <span class="token keyword">if</span> to_cpu<span class="token punctuation">:</span>
        deviceid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        deviceid <span class="token operator">=</span> A<span class="token punctuation">.</span>page_deviceid

    num_bytes <span class="token operator">=</span> dtype2bytes<span class="token punctuation">[</span>A<span class="token punctuation">.</span>dtype<span class="token punctuation">]</span> <span class="token operator">*</span> A<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lib<span class="token punctuation">.</span>cprefetch<span class="token punctuation">(</span>get_ptr<span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_size_t<span class="token punctuation">(</span>num_bytes<span class="token punctuation">)</span><span class="token punctuation">,</span> ct<span class="token punctuation">.</span>c_int32<span class="token punctuation">(</span>deviceid<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><a href="https://github.com/TimDettmers/bitsandbytes/blob/main/csrc/pythonInterface.cpp#L389" target="_blank" rel="noopener noreferrer">https://github.com/TimDettmers/bitsandbytes/blob/main/csrc/pythonInterface.cpp#L389<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-c++ extra-class"><pre class="language-text"><code>void cprefetch(void *ptr, size_t bytes, int device)
{
  int hasPrefetch = 0;
  CUDA_CHECK_RETURN(cudaDeviceGetAttribute(&amp;hasPrefetch, cudaDevAttrConcurrentManagedAccess, device)); // 40ns overhead
  if (hasPrefetch == 0) return;

  CUDA_CHECK_RETURN(cudaMemPrefetchAsync(ptr, bytes, device, 0));
  CUDA_CHECK_RETURN(cudaPeekAtLastError());
}
</code></pre></div><p>实际调用的是CUDA的接口，<code>cudaMemPrefetchAsync</code> 是 CUDA 提供的一个异步内存预取函数，用于在程序中显式地预取内存数据到 GPU 上，以加速后续对数据的访问。</p> <p>整个流程是我们把内存交给CUDA管理，在优化器需要内存时，我们提示CUDA需要在GPU上用到多少内存，提前传输过去，加速后续访问。如果GPU内存吃紧，CUDA会自动把部分数据传输回CPU内存。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://arxiv.org/pdf/2106.09685.pdf" target="_blank" rel="noopener noreferrer">LORA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://arxiv.org/pdf/2305.14314v1.pdf" target="_blank" rel="noopener noreferrer">QLoRA: Efficient Finetuning of Quantized LLMs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fancyerii.github.io/2023/12/14/qlora/" target="_blank" rel="noopener noreferrer">QLoRA: Efficient Finetuning of Quantized LLMs论文解读<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://readpaper.feishu.cn/docx/CrMGdSVPKow5d1x1XQMcJioRnQe" target="_blank" rel="noopener noreferrer">QLoRA: 训练更大的GPT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://huggingface.co/blog/zh/4bit-transformers-bitsandbytes" target="_blank" rel="noopener noreferrer">用 bitsandbytes、4 比特量化和 QLoRA 打造亲民的 LLM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#前言" title="前言">前言</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#lora" title="LoRA">LoRA</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#qlora" title="QLoRA">QLoRA</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-bit-normalfloat-quantization" title="4-bit NormalFloat Quantization">4-bit NormalFloat Quantization</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#double-quantization" title="Double Quantization">Double Quantization</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#paged-optimizers" title="Paged Optimizers">Paged Optimizers</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考" title="参考">参考</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d26a87a3.js" defer></script><script src="/assets/js/6.f588e3a4.js" defer></script><script src="/assets/js/3.46d2affe.js" defer></script><script src="/assets/js/18.83909f3e.js" defer></script>
  </body>
</html>
